$.ajax({url:"./arrow.fabric.js",dataType:"script",async:!1}),$.ajax({url:"./rect.fabric.js",dataType:"script",async:!1}),$.ajax({url:"./ellipse.fabric.js",dataType:"script",async:!1});var PDFAnnotate=function(t,e,c={}){this.number_of_pages=0,this.pages_rendered=0,this.active_tool=1,this.fabricObjects=[],this.fabricObjectsData=[],this.color="#212121",this.borderColor="#000000",this.forceFillOpacity=!1,this.fillOpacity=0,this.borderSize=1,this.font_size=16,this.active_canvas=0,this.container_id=t,this.url=e,this.pageImageCompression=c.pageImageCompression?c.pageImageCompression.toUpperCase():"NONE",this.textBoxText="Sample Text",this.format,this.orientation;var o=this;pdfjsLib.getDocument(this.url).promise.then(function(t){var n=c.scale||1.3;o.number_of_pages=t.numPages;for(var e=1;e<=t.numPages;e++)t.getPage(e).then(function(t){void 0!==o.format&&void 0!==o.orientation||(e=t.getViewport({scale:1}),o.format=[e.width,e.height],o.orientation=e.width>e.height?"landscape":"portrait");var e=t.getViewport({scale:n}),a=document.createElement("canvas"),a=(document.getElementById(o.container_id).appendChild(a),a.className="pdf-canvas",a.height=e.height,a.width=e.width,{canvasContext:context=a.getContext("2d"),viewport:e});t.render(a).promise.then(function(){$(".pdf-canvas").each(function(t,e){$(e).attr("id","page-"+(t+1)+"-canvas")}),o.pages_rendered++,o.pages_rendered==o.number_of_pages&&o.initFabric()})})},function(t){console.error(t)}),this.initFabric=function(){var r=this;let a=$("#"+r.container_id+" canvas");a.each(function(o,t){var e=t.toDataURL("image/png"),i=new fabric.Canvas(t.id,{freeDrawingBrush:{width:1,color:r.color}});r.fabricObjects.push(i),"function"==typeof c.onPageUpdated&&i.on("object:added",function(){var t=Object.assign({},r.fabricObjectsData[o]);r.fabricObjectsData[o]=i.toJSON(),c.onPageUpdated(o+1,t,r.fabricObjectsData[o])}),i.setBackgroundImage(e,i.renderAll.bind(i)),$(i.upperCanvasEl).on("mousedown",function(t){$(this).data("p0",{x:t.pageX,y:t.pageY})}).on("mouseup",function(t){var e=$(this).data("p0"),a=t.pageX,n=t.pageY;Math.sqrt(Math.pow(a-e.x,2)+Math.pow(n-e.y,2))<4&&(r.active_canvas=o,r.fabricClickHandler(t,i))}),i.on("after:render",function(){r.fabricObjectsData[o]=i.toJSON(),i.off("after:render")}),o===a.length-1&&"function"==typeof c.ready&&c.ready()})},this.fabricClickHandler=function(t,e){var a,n=this;(a=2==n.active_tool?new fabric.IText(n.textBoxText,{left:t.clientX-e.upperCanvasEl.getBoundingClientRect().left,top:t.clientY-e.upperCanvasEl.getBoundingClientRect().top,fill:n.color,fontSize:n.font_size,selectable:!0}):a)&&e.add(a)}};PDFAnnotate.prototype.enableSelector=function(){var t=this;(t.active_tool=0)<t.fabricObjects.length&&$.each(t.fabricObjects,function(t,e){e.isDrawingMode=!1})},PDFAnnotate.prototype.enablePencil=function(){var t=this;t.active_tool=1,0<t.fabricObjects.length&&$.each(t.fabricObjects,function(t,e){e.isDrawingMode=!0})},PDFAnnotate.prototype.enableAddText=function(t){var e=this;e.active_tool=2,"string"==typeof t&&(e.textBoxText=t),0<e.fabricObjects.length&&$.each(e.fabricObjects,function(t,e){e.isDrawingMode=!1})},PDFAnnotate.prototype.enableRectangle=function(){var a=this;a.active_tool=4,0<a.fabricObjects.length&&$.each(a.fabricObjects,function(t,e){e.isDrawingMode=!1,new Rectangle(e,a.color,a.borderSize,null)})},PDFAnnotate.prototype.enableEllipse=function(){var a=this;a.active_tool=5,0<a.fabricObjects.length&&$.each(a.fabricObjects,function(t,e){e.isDrawingMode=!1,new Ellipse(e,a.color,a.borderSize,null)})},PDFAnnotate.prototype.enableAddArrow=function(a=null){var n=this;n.active_tool=3,0<n.fabricObjects.length&&$.each(n.fabricObjects,function(t,e){e.isDrawingMode=!1,new Arrow(e,n.color,function(){"function"==typeof a&&a()})})},PDFAnnotate.prototype.addImageToCanvas=function(){var e,a=this.fabricObjects[this.active_canvas];a&&((e=document.createElement("input")).type="file",e.accept=".jpg,.jpeg,.png,.PNG,.JPG,.JPEG",e.onchange=function(){var t=new FileReader;t.addEventListener("load",function(){e.remove();var t=new Image;t.onload=function(){a.add(new fabric.Image(t))},t.src=this.result},!1),t.readAsDataURL(e.files[0])},document.getElementsByTagName("body")[0].appendChild(e),e.click())},PDFAnnotate.prototype.deleteSelectedObject=function(){var t=this.fabricObjects[this.active_canvas].getActiveObject();t&&confirm("Are you sure ?")&&this.fabricObjects[this.active_canvas].remove(t)},PDFAnnotate.prototype.savePdf=function(a){var n,o=this,i=o.format||"a4",r=o.orientation||"portrait";o.fabricObjects.length&&(n=new jspdf.jsPDF({format:i,orientation:r}),void 0===a&&(a=(new Date).getTime()+".pdf"),o.fabricObjects.forEach(function(t,e){0!=e&&(n.addPage(i,r),n.setPage(e+1)),n.addImage(t.toDataURL({format:"png"}),"NONE"==o.pageImageCompression?"PNG":"JPEG",0,0,n.internal.pageSize.getWidth(),n.internal.pageSize.getHeight(),"page-"+(e+1),0<=["FAST","MEDIUM","SLOW"].indexOf(o.pageImageCompression)?o.pageImageCompression:void 0),e===o.fabricObjects.length-1&&n.save(a)}))},PDFAnnotate.prototype.setBrushSize=function(a){$.each(this.fabricObjects,function(t,e){e.freeDrawingBrush.width=parseInt(a,10)||1})},PDFAnnotate.prototype.setColor=function(a){this.forceFillOpacity&&((a=new fabric.Color(a)).setAlpha(this.fillOpacity),a=a.toRgba()),this.color=a,$.each(this.fabricObjects,function(t,e){e.freeDrawingBrush.color=a})},PDFAnnotate.prototype.setBorderColor=function(t){this.borderColor=t},PDFAnnotate.prototype.setFontSize=function(t){this.font_size=t},PDFAnnotate.prototype.setBorderSize=function(t){this.borderSize=t},PDFAnnotate.prototype.setFillOpacity=function(t){this.forceFillOpacity=!0,this.fillOpacity=t},PDFAnnotate.prototype.clearActivePage=function(){var t=this.fabricObjects[this.active_canvas],e=t.backgroundImage;confirm("Are you sure?")&&(t.clear(),t.setBackgroundImage(e,t.renderAll.bind(t)))},PDFAnnotate.prototype.serializePdf=function(e){var a=this,n=[];a.fabricObjects.forEach(function(t){t.clone(function(t){t.setBackgroundImage(null),t.setBackgroundColor(""),n.push(t),n.length===a.fabricObjects.length&&(t={page_setup:{format:a.format,orientation:a.orientation},pages:n},e(JSON.stringify(t)))})})},PDFAnnotate.prototype.loadFromJSON=function(t){var a=this,{page_setup:e,pages:n}=t;void 0===n&&(n=t),"object"==typeof e&&"string"==typeof e.format&&"string"==typeof e.orientation&&(a.format=e.format,a.orientation=e.orientation),$.each(a.fabricObjects,function(t,e){n.length>t&&e.loadFromJSON(n[t],function(){a.fabricObjectsData[t]=e.toJSON()})})},PDFAnnotate.prototype.setDefaultTextForTextBox=function(t){"string"==typeof t&&(this.textBoxText=t)};
