const{PDFDocument,rgb}=PDFLib;var PDFAnnotate=function(t,e,c={}){this.number_of_pages=0,this.pages_rendered=0,this.active_tool=1,this.active_tool_obj,this.fabricObjects=[],this.fabricObjectsData=[],this.font_size=16,this.active_canvas=0,this.container_id=t,this.origPdfBytes,this.textBoxText="Sample Text",this.format,this.orientation,this.autoConfirmBeforeDeletingObject=!0,this.scale=1.5,this.brush=new Brush(function(n){$.each(a.fabricObjects,function(t,e){e.freeDrawingBrush.color=n.color,e.freeDrawingBrush.width=n.brushSize})});var a=this;fetch(e).then(function(t){t.arrayBuffer().then(function(t){a.origPdfBytes=t,a.initPDFjs()})}),this.initPDFjs=function(){pdfjsLib.getDocument({data:a.origPdfBytes}).promise.then(function(t){a.scale=c.scale||a.scale,a.number_of_pages=t.numPages;for(var e=1;e<=t.numPages;e++)t.getPage(e).then(function(t){void 0!==a.format&&void 0!==a.orientation||(e=t.getViewport({scale:1}),a.format=[e.width,e.height],a.orientation=e.width>e.height?"landscape":"portrait");var e=t.getViewport({scale:a.scale}),n=document.createElement("div"),o=(document.getElementById(a.container_id).appendChild(n),$(n).attr("id","page-"+t.pageNumber+"-container"),n.className="page-container",document.createElement("canvas")),n=(n.appendChild(o),o.className="pdf-canvas",o.height=e.height,o.width=e.width,$(o).attr("id","page-"+t.pageNumber+"-pdf-canvas"),{canvasContext:context=o.getContext("2d"),viewport:e});t.render(n).promise.then(function(){a.pages_rendered++,a.pages_rendered==a.number_of_pages&&a.initFabric()})})},function(t){console.error(t)})},this.initFabric=function(){var r=this;let o=$("#"+r.container_id+" .page-container");o.each(function(a,t){var e=$(t).children().first()[0],n=document.createElement("div"),t=(t.appendChild(n),$(n).css("position","absolute"),$(n).css("height",$(e).height()),$(n).css("width",$(e).width()),$(n).css("left",$(e).position().left),$(n).css("top",$(e).position().top),$(n).css("z-index","1"),document.createElement("canvas")),i=(n.appendChild(t),$(t).attr("id","page-"+a+"-fabric-canvas"),new fabric.Canvas(t.id,{freeDrawingBrush:{width:r.brush.brushSize,color:r.brush.color}}));i.setHeight($(e).height()),i.setWidth($(e).width()),r.fabricObjects.push(i),"function"==typeof c.onPageUpdated&&i.on("object:added",function(){var t=Object.assign({},r.fabricObjectsData[a]);r.fabricObjectsData[a]=i.toJSON(),c.onPageUpdated(a+1,t,r.fabricObjectsData[a])}),$(i.upperCanvasEl).on("mousedown",function(t){$(this).data("p0",{x:t.pageX,y:t.pageY})}).on("mouseup",function(t){r.active_canvas=a;var e=$(this).data("p0"),n=t.pageX,o=t.pageY;Math.sqrt(Math.pow(n-e.x,2)+Math.pow(o-e.y,2))<4&&r.fabricClickHandler(t,i)}),i.on("after:render",function(){r.fabricObjectsData[a]=i.toJSON(),i.off("after:render")}),a===o.length-1&&"function"==typeof c.ready&&c.ready()})},this.fabricClickHandler=function(t,e){var n,o=this;(n=2==o.active_tool?new fabric.IText(o.textBoxText,{left:t.clientX-e.upperCanvasEl.getBoundingClientRect().left,top:t.clientY-e.upperCanvasEl.getBoundingClientRect().top,fill:o.brush.color,fontSize:o.font_size,selectable:!0}):n)&&e.add(n)}};PDFAnnotate.prototype.disableDrawingTool=function(){var t=this;t.active_tool_obj&&($.each(t.active_tool_obj,function(t,e){e.stop()}),t.active_tool_obj=null),t.active_tool=0},PDFAnnotate.prototype.setDrawingTool=function(t,e){var n=this;n.active_tool_obj&&console.log("Previous drawing tool was not disabled"),n.active_tool=t,n.active_tool_obj=e},PDFAnnotate.prototype.enableSelector=function(){var t=this;t.disableDrawingTool(),t.setDrawingTool(0,null),0<t.fabricObjects.length&&$.each(t.fabricObjects,function(t,e){e.isDrawingMode=!1})},PDFAnnotate.prototype.enablePencil=function(){var t=this;t.disableDrawingTool(),t.setDrawingTool(1,null),0<t.fabricObjects.length&&$.each(t.fabricObjects,function(t,e){e.isDrawingMode=!0})},PDFAnnotate.prototype.enableAddText=function(t){var e=this;e.disableDrawingTool(),e.setDrawingTool(2,null),"string"==typeof t&&(e.textBoxText=t),0<e.fabricObjects.length&&$.each(e.fabricObjects,function(t,e){e.isDrawingMode=!1})},PDFAnnotate.prototype.enableRectangle=function(){var n=this,o=[];n.disableDrawingTool(),0<n.fabricObjects.length&&$.each(n.fabricObjects,function(t,e){e.isDrawingMode=!1,o.push(new Rectangle(e,n.brush,null))}),n.setDrawingTool(4,o)},PDFAnnotate.prototype.enableEllipse=function(){var n=this,o=[];n.disableDrawingTool(),0<n.fabricObjects.length&&$.each(n.fabricObjects,function(t,e){e.isDrawingMode=!1,o.push(new Ellipse(e,n.brush,null))}),n.setDrawingTool(5,o)},PDFAnnotate.prototype.enableAddArrow=function(n=null){var o=this,a=[];o.disableDrawingTool(),0<o.fabricObjects.length&&$.each(o.fabricObjects,function(t,e){e.isDrawingMode=!1,a.push(new Arrow(e,o.brush,function(){"function"==typeof n&&n()}))}),o.setDrawingTool(3,a)},PDFAnnotate.prototype.addImageToCanvas=function(){var e,n=this.fabricObjects[this.active_canvas];n&&((e=document.createElement("input")).type="file",e.accept=".jpg,.jpeg,.png,.PNG,.JPG,.JPEG",e.onchange=function(){var t=new FileReader;t.addEventListener("load",function(){e.remove();var t=new Image;t.onload=function(){n.add(new fabric.Image(t))},t.src=this.result},!1),t.readAsDataURL(e.files[0])},document.getElementsByTagName("body")[0].appendChild(e),e.click())},PDFAnnotate.prototype.deleteSelectedObject=function(){var t=this,e=t.fabricObjects[t.active_canvas].getActiveObject();e&&(t.autoConfirmBeforeDeletingObject||confirm("Are you sure ?"))&&t.fabricObjects[t.active_canvas].remove(e)},PDFAnnotate.prototype.savePdf=async function(t,e){var o=this;e=e??{};const a=await PDFDocument.load(o.origPdfBytes);o.fabricObjects.forEach(async function(t,e){var e=a.getPage(e),n=await a.embedPng(t.toDataURL({format:"png"}));e.drawImage(n,{x:t.x,y:t.y,width:t.width/o.scale,height:t.height/o.scale})});var n=await a.save();if("download"==t)"undefined"==typeof(fileName=e.filename)&&(fileName=(new Date).getTime()+".pdf"),download(n,fileName,"application/pdf");else if("upload"==t)try{var i=await(await fetch(e.url,{method:"POST",body:n,headers:{"Content-Type":"application/pdf"}})).json(),r=i.statusText??"No response from server";i.ok?console.log(r):alert("Failed to send PDF: "+r)}catch(t){alert("Error uploading PDF: "+t)}},PDFAnnotate.prototype.setFontSize=function(t){this.font_size=t},PDFAnnotate.prototype.setBrushSize=function(t){this.brush.setBrushSize(t)},PDFAnnotate.prototype.setColor=function(t){this.brush.setColor(t)},PDFAnnotate.prototype.setBorderColor=function(t){this.brush.setBorderColor(t)},PDFAnnotate.prototype.setBorderSize=function(t){this.brush.setBorderSize(t)},PDFAnnotate.prototype.setFillOpacity=function(t){this.brush.setFillOpacity(t)},PDFAnnotate.prototype.clearActivePage=function(){var t=this.fabricObjects[this.active_canvas],e=t.backgroundImage;confirm("Are you sure?")&&(t.clear(),t.setBackgroundImage(e,t.renderAll.bind(t)))},PDFAnnotate.prototype.serializePdf=function(e){var n=this,o=[];n.fabricObjects.forEach(function(t){t.clone(function(t){t.setBackgroundImage(null),t.setBackgroundColor(""),o.push(t),o.length===n.fabricObjects.length&&(t={page_setup:{format:n.format,orientation:n.orientation},pages:o},e(JSON.stringify(t)))})})},PDFAnnotate.prototype.loadFromJSON=function(t){var n=this,{page_setup:e,pages:o}=t;void 0===o&&(o=t),"object"==typeof e&&"string"==typeof e.format&&"string"==typeof e.orientation&&(n.format=e.format,n.orientation=e.orientation),$.each(n.fabricObjects,function(t,e){o.length>t&&e.loadFromJSON(o[t],function(){n.fabricObjectsData[t]=e.toJSON()})})},PDFAnnotate.prototype.setDefaultTextForTextBox=function(t){"string"==typeof t&&(this.textBoxText=t)};
