var Brush=function(t){this.color="#212121",this.borderColor="#000000",this.alpha=1,this.brushSize=1,this.borderSize=1,this.onUpdateCallback=t},Arrow=(Brush.prototype.setBrushSize=function(t){var e=this;e.brushSize=parseInt(t,10)||1,"function"==typeof e.onUpdateCallback&&e.onUpdateCallback(e)},Brush.prototype.setColor=function(t,e=1){var n=this;(t=new fabric.Color(t)).setAlpha(e),t=t.toRgba(),n.alpha=e,n.color=t,"function"==typeof n.onUpdateCallback&&n.onUpdateCallback(n)},Brush.prototype.setBorderColor=function(t){var e=this;e.borderColor=t,"function"==typeof e.onUpdateCallback&&e.onUpdateCallback(e)},Brush.prototype.setBorderSize=function(t){var e=this;e.borderSize=t,"function"==typeof e.onUpdateCallback&&e.onUpdateCallback(e)},fabric.LineArrow=fabric.util.createClass(fabric.Line,{type:"lineArrow",initialize:function(t,e){this.callSuper("initialize",t,e=e||{})},toObject:function(){return fabric.util.object.extend(this.callSuper("toObject"))},_render:function(t){var e,n;this.callSuper("_render",t),0!==this.width&&0!==this.height&&this.visible&&(t.save(),e=this.x2-this.x1,n=this.y2-this.y1,n=Math.atan2(n,e),t.translate((this.x2-this.x1)/2,(this.y2-this.y1)/2),t.rotate(n),t.beginPath(),t.moveTo(10,0),t.lineTo(-20,15),t.lineTo(-20,-15),t.closePath(),t.fillStyle=this.stroke,t.fill(),t.restore())}}),fabric.LineArrow.fromObject=function(t,e){e&&e(new fabric.LineArrow([t.x1,t.y1,t.x2,t.y2],t))},fabric.LineArrow.async=!0,function(){function t(t,e,n){this.canvas=t,this.className="Arrow",this.isDrawing=!1,this.brush=e,this.callback=n,this.bindEvents()}return t.prototype.bindEvents=function(){var e=this;e.canvas.on("mouse:down",function(t){e.onMouseDown(t)}),e.canvas.on("mouse:move",function(t){e.onMouseMove(t)}),e.canvas.on("mouse:up",function(t){e.onMouseUp(t)}),e.canvas.on("object:moving",function(t){e.disable()})},t.prototype.stop=function(){this.unBindEvents()},t.prototype.unBindEvents=function(){var t=this;t.canvas.off("mouse:down"),t.canvas.off("mouse:up"),t.canvas.off("mouse:move"),t.canvas.off("object:moving")},t.prototype.onMouseUp=function(t){var e=this;e.disable(),e.callback&&e.callback()},t.prototype.onMouseMove=function(t){var e,n=this;n.isEnable()&&(t=n.canvas.getPointer(t.e),(e=n.canvas.getActiveObject()).set({x2:t.x,y2:t.y}),e.setCoords(),n.canvas.renderAll())},t.prototype.onMouseDown=function(t){var e=this;t.target||(e.enable(),t=[(t=e.canvas.getPointer(t.e)).x,t.y,t.x,t.y],t=new fabric.LineArrow(t,{strokeWidth:5,fill:e.brush.color||"red",stroke:e.brush.color||"red",originX:"center",originY:"center",hasBorders:!1,hasControls:!0,selectable:!0}),e.canvas.add(t).setActiveObject(t))},t.prototype.isEnable=function(){return this.isDrawing},t.prototype.enable=function(){this.isDrawing=!0},t.prototype.disable=function(){this.isDrawing=!1},t}()),Rectangle=(fabric.InteractiveRectangle=fabric.util.createClass(fabric.Rect,{type:"InteractiveRectangle",initialize:function(t){this.callSuper("initialize",t=t||{})},toObject:function(){return fabric.util.object.extend(this.callSuper("toObject"))}}),function(){function t(t,e,n){this.canvas=t,this.className="Rectangle",this.isDrawing=!1,this.brush=e,this.callback=n,this.bindEvents()}return t.prototype.stop=function(){this.unBindEvents()},t.prototype.bindEvents=function(){var e=this;e.canvas.on("mouse:down",function(t){e.onMouseDown(t)}),e.canvas.on("mouse:move",function(t){e.onMouseMove(t)}),e.canvas.on("mouse:up",function(t){e.onMouseUp(t)}),e.canvas.on("object:moving",function(t){e.disable()})},t.prototype.unBindEvents=function(){var t=this;t.canvas.off("mouse:down"),t.canvas.off("mouse:up"),t.canvas.off("mouse:move"),t.canvas.off("object:moving")},t.prototype.onMouseUp=function(t){var e=this;e.disable(),e.callback&&e.callback()},t.prototype.onMouseMove=function(t){var e;this.isEnable()&&(t=this.canvas.getPointer(t.e),(e=this.canvas.getActiveObject()).set({width:Math.abs(e.left-t.x),height:Math.abs(e.top-t.y),originX:e.left<t.x?"left":"right",originY:e.top<t.y?"top":"bottom"}),e.setCoords(),this.canvas.renderAll())},t.prototype.onMouseDown=function(t){var e=this;t.target||(e.enable(),t=e.canvas.getPointer(t.e),t=new fabric.InteractiveRectangle({strokeWidth:e.brush.borderSize,fill:e.brush.color||"red",stroke:e.brush.color||"red",hasBorders:!1,hasControls:!0,selectable:!0,left:t.x,top:t.y}),e.canvas.add(t).setActiveObject(t))},t.prototype.isEnable=function(){return this.isDrawing},t.prototype.enable=function(){this.isDrawing=!0},t.prototype.disable=function(){this.isDrawing=!1},t}()),Ellipse=(fabric.InteractiveEllipse=fabric.util.createClass(fabric.Ellipse,{type:"InteractiveEllipse",initialize:function(t){this.callSuper("initialize",t=t||{})},toObject:function(){return fabric.util.object.extend(this.callSuper("toObject"))}}),function(){function t(t,e,n){this.canvas=t,this.className="Ellipse",this.isDrawing=!1,this.brush=e,this.callback=n,this.bindEvents()}return t.prototype.stop=function(){this.unBindEvents()},t.prototype.bindEvents=function(){var e=this;e.canvas.on("mouse:down",function(t){e.onMouseDown(t)}),e.canvas.on("mouse:move",function(t){e.onMouseMove(t)}),e.canvas.on("mouse:up",function(t){e.onMouseUp(t)}),e.canvas.on("object:moving",function(t){e.disable()})},t.prototype.unBindEvents=function(){this.canvas.off("mouse:down"),this.canvas.off("mouse:up"),this.canvas.off("mouse:move"),this.canvas.off("object:moving")},t.prototype.onMouseUp=function(t){this.disable(),this.callback&&this.callback()},t.prototype.onMouseMove=function(t){var e;this.isEnable()&&(t=this.canvas.getPointer(t.e),(e=this.canvas.getActiveObject()).set({rx:Math.abs(e.left-t.x)/2,ry:Math.abs(e.top-t.y)/2,originX:e.left<t.x?"left":"right",originY:e.top<t.y?"top":"bottom"}),e.setCoords(),this.canvas.renderAll())},t.prototype.onMouseDown=function(t){var e=this;t.target||(e.enable(),t=e.canvas.getPointer(t.e),t=new fabric.InteractiveEllipse({strokeWidth:e.brush.borderSize,fill:e.brush.color||"red",stroke:e.brush.color||"red",hasBorders:!1,hasControls:!0,selectable:!0,left:t.x,top:t.y}),e.canvas.add(t).setActiveObject(t))},t.prototype.isEnable=function(){return this.isDrawing},t.prototype.enable=function(){this.isDrawing=!0},t.prototype.disable=function(){this.isDrawing=!1},t}());const{PDFDocument,rgb}=PDFLib,TOOL_NONE=0,TOOL_SELECTOR=1,TOOL_FREEHAND=2,TOOL_TEXT=3,TOOL_ARROW=4,TOOL_RECTANGLE=5,TOOL_ELLIPSE=6;var PDFAnnotate=function(t,e,r={}){this.number_of_pages=0,this.pages_rendered=0,this.active_tool=TOOL_NONE,this.active_tool_obj,this.fabricObjects=[],this.fabricObjectsData=[],this.font_size=16,this.active_canvas=0,this.container_id=t,this.origPdfBytes,this.textBoxText="Sample Text",this.format,this.orientation,this.autoConfirmBeforeDeletingObject=!0,this.scale=1.5,this.needSave=!1,this.pdfjs,this.renderTasks={};var a=this;this.brush=new Brush(function(n){$.each(a.fabricObjects,function(t,e){e.freeDrawingBrush.color=n.color,e.freeDrawingBrush.width=n.brushSize})}),fetch(e).then(function(t){t.arrayBuffer().then(function(t){a.origPdfBytes=t,a.initPDFjs()})}),this.initPDFjs=function(){pdfjsLib.getDocument({data:a.origPdfBytes}).promise.then(function(t){a.pdfjs=t,a.scale=r.scale||a.scale,a.number_of_pages=t.numPages;for(var e=1;e<=t.numPages;e++)t.getPage(e).then(function(t){void 0!==a.format&&void 0!==a.orientation||(e=t.getViewport({scale:1}),a.format=[e.width,e.height],a.orientation=e.width>e.height?"landscape":"portrait");var e=t.getViewport({scale:a.scale}),n=document.createElement("div"),o=(document.getElementById(a.container_id).appendChild(n),$(n).attr("id","page-"+t.pageNumber+"-container"),n.className="pdfannotate-page-container",document.createElement("canvas")),n=(n.appendChild(o),o.className="pdfannotate-pdf-canvas",o.height=e.height,o.width=e.width,$(o).attr("id","page-"+t.pageNumber+"-pdf-canvas"),{canvasContext:context=o.getContext("2d"),viewport:e});t.render(n).promise.then(function(){a.pages_rendered++,a.pages_rendered==a.number_of_pages&&a.initFabric()})})},function(t){console.error(t)})},this.initFabric=function(){var s=this;let o=$("#"+s.container_id+" .pdfannotate-page-container");o.each(function(a,t){var e=$(t).children().first()[0],n=document.createElement("div"),t=(n.className="pdfannotate-fabric-canvas pdfannotate-locked",t.appendChild(n),$(n).attr("id","page-"+a+"-fabric-canvas-wrapper"),$(n).css("height",$(e).height()),$(n).css("width",$(e).width()),$(n).css("z-index","1"),document.createElement("canvas")),i=(n.appendChild(t),$(t).attr("id","page-"+a+"-fabric-canvas"),new fabric.Canvas(t.id));i.freeDrawingBrush.width=s.brush.brushSize,i.freeDrawingBrush.color=s.brush.color,i.setHeight($(e).height()),i.setWidth($(e).width()),i.setViewportTransform([s.scale,0,0,s.scale,0,0]),s.fabricObjects.push(i),"function"==typeof r.onPageUpdated&&i.on("object:added",function(){var t=Object.assign({},s.fabricObjectsData[a]);s.fabricObjectsData[a]=i.toJSON(),r.onPageUpdated(a+1,t,s.fabricObjectsData[a])}),$(i.upperCanvasEl).on("mousedown",function(t){s.active_tool!=TOOL_NONE&&(s.active_tool>TOOL_SELECTOR&&(s.needSave=!0),$(this).data("p0",{x:t.pageX,y:t.pageY}))}).on("mouseup",function(t){s.active_canvas=a;var e,n,o=$(this).data("p0");void 0!==o&&(e=t.pageX,n=t.pageY,Math.sqrt(Math.pow(e-o.x,2)+Math.pow(n-o.y,2))<4)&&s.fabricClickHandler(t,i)}),i.on("after:render",function(){s.fabricObjectsData[a]=i.toJSON(),i.off("after:render")}),a===o.length-1&&"function"==typeof r.ready&&r.ready()})},this.fabricClickHandler=function(t,e){var n,o=this;(n=o.active_tool==TOOL_TEXT?new fabric.IText(o.textBoxText,{left:(t.clientX-e.upperCanvasEl.getBoundingClientRect().left)/o.scale,top:(t.clientY-e.upperCanvasEl.getBoundingClientRect().top)/o.scale,fill:o.brush.color,fontSize:o.font_size,selectable:!0}):n)&&e.add(n)}};PDFAnnotate.prototype.zoom=function(t){var s=this;null!=s.pdfjs&&(s.scale*=1-t/1e3,s.fabricObjects.forEach(function(a,i){s.pdfjs.getPage(i+1).then(function(t){var e=t.getViewport({scale:s.scale}),n=$("#page-"+(i+1)+"-pdf-canvas").get(0),o=(n.height=e.height,n.width=e.width,n.getContext("2d")),t=(s.render(t,{canvasContext:o,viewport:e}),$("#page-"+i+"-fabric-canvas-wrapper").get(0));$(t).css("height",$(n).height()),$(t).css("width",$(n).width()),a.setHeight($(n).height()),a.setWidth($(n).width()),a.setViewportTransform([s.scale,0,0,s.scale,0,0])})}))},PDFAnnotate.prototype.render=function(t,e){var n,o=this;t.pageNumber in o.renderTasks?o.renderTasks[t.pageNumber]=e:(n=t.render(e),o.renderTasks[t.pageNumber]="ongoing",n.promise.then(function(){"ongoing"==o.renderTasks[t.pageNumber]?delete o.renderTasks[t.pageNumber]:(e=o.renderTasks[t.pageNumber],delete o.renderTasks[t.pageNumber],o.render(t,e))}))},PDFAnnotate.prototype.disableDrawingTool=function(){var t=this;t.active_tool_obj&&($.each(t.active_tool_obj,function(t,e){e.stop()}),t.active_tool_obj=null),t.active_tool=TOOL_NONE,$.each(t.fabricObjects,(t,e)=>e.discardActiveObject().renderAll()),$(".pdfannotate-fabric-canvas").addClass("pdfannotate-locked")},PDFAnnotate.prototype.setDrawingTool=function(t,e){this.active_tool_obj&&console.log("Previous drawing tool was not disabled"),this.active_tool=t,this.active_tool_obj=e,$(".pdfannotate-fabric-canvas").removeClass("pdfannotate-locked")},PDFAnnotate.prototype.enableSelector=function(){this.disableDrawingTool(),this.setDrawingTool(TOOL_SELECTOR,null),0<this.fabricObjects.length&&$.each(this.fabricObjects,function(t,e){e.isDrawingMode=!1})},PDFAnnotate.prototype.enablePencil=function(){this.disableDrawingTool(),this.setDrawingTool(TOOL_FREEHAND,null),0<this.fabricObjects.length&&$.each(this.fabricObjects,function(t,e){e.isDrawingMode=!0})},PDFAnnotate.prototype.enableAddText=function(t){var e=this;e.disableDrawingTool(),e.setDrawingTool(TOOL_TEXT,null),"string"==typeof t&&(e.textBoxText=t),0<e.fabricObjects.length&&$.each(e.fabricObjects,function(t,e){e.isDrawingMode=!1})},PDFAnnotate.prototype.enableRectangle=function(){var n=this,o=[];n.disableDrawingTool(),0<n.fabricObjects.length&&$.each(n.fabricObjects,function(t,e){e.isDrawingMode=!1,o.push(new Rectangle(e,n.brush,null))}),n.setDrawingTool(TOOL_RECTANGLE,o)},PDFAnnotate.prototype.enableEllipse=function(){var n=this,o=[];n.disableDrawingTool(),0<n.fabricObjects.length&&$.each(n.fabricObjects,function(t,e){e.isDrawingMode=!1,o.push(new Ellipse(e,n.brush,null))}),n.setDrawingTool(TOOL_ELLIPSE,o)},PDFAnnotate.prototype.enableAddArrow=function(n=null){var o=this,a=[];o.disableDrawingTool(),0<o.fabricObjects.length&&$.each(o.fabricObjects,function(t,e){e.isDrawingMode=!1,a.push(new Arrow(e,o.brush,function(){"function"==typeof n&&n()}))}),o.setDrawingTool(TOOL_ARROW,a)},PDFAnnotate.prototype.addImageToCanvas=function(){var e,n=this,o=n.fabricObjects[n.active_canvas];o&&((e=document.createElement("input")).type="file",e.accept=".jpg,.jpeg,.png,.PNG,.JPG,.JPEG",e.onchange=function(){var t=new FileReader;t.addEventListener("load",function(){e.remove();var t=new Image;t.onload=function(){o.add(new fabric.Image(t))},t.src=this.result,n.needSave=!0},!1),t.readAsDataURL(e.files[0])},document.getElementsByTagName("body")[0].appendChild(e),e.click())},PDFAnnotate.prototype.deleteSelectedObject=function(){var t=this,e=t.fabricObjects[t.active_canvas].getActiveObject();e&&(t.autoConfirmBeforeDeletingObject||confirm("Are you sure ?"))&&t.fabricObjects[t.active_canvas].remove(e)},PDFAnnotate.prototype.savePdf=async function(t,e){var r=this;e=e??{};const c=await PDFDocument.load(r.origPdfBytes);r.fabricObjects.forEach(async function(t,e){var e=c.getPage(e),n=e.getRotation(),o=t.height,a=t.width,i=(t.setHeight(o/(r.scale/2.5)),t.setWidth(a/(r.scale/2.5)),t.setViewportTransform([2.5,0,0,2.5,0,0]),await c.embedPng(t.toDataURL({format:"png"}))),s=0;90==n.angle&&(s=t.height/2.5),e.drawImage(i,{x:s,y:0,width:t.width/2.5,height:t.height/2.5,rotate:n}),t.setHeight(o),t.setWidth(a),t.setViewportTransform([r.scale,0,0,r.scale,0,0])});var n=await c.save();if("download"==t)return"undefined"==typeof(fileName=e.filename)&&(fileName=(new Date).getTime()+".pdf"),download(n,fileName,"application/pdf"),!(r.needSave=!1);if("upload"==t)try{var o=new URLSearchParams(e.requestArgs),a=new FormData;a.append("file",new Blob([n],{type:"application/pdf"}));var i=await(await fetch(e.url+"?"+o.toString(),{method:"POST",body:a})).json(),s=i.statusText??"No response from server";return i.ok?(console.log(s),!(r.needSave=!1)):(console.error("Failed to send PDF: "+s),!1)}catch(t){return console.error("Error uploading PDF: "+t),!1}},PDFAnnotate.prototype.setFontSize=function(t){this.font_size=t},PDFAnnotate.prototype.setBrushSize=function(t){this.brush.setBrushSize(t)},PDFAnnotate.prototype.setColor=function(t,e=1){this.brush.setColor(t,e)},PDFAnnotate.prototype.setBorderColor=function(t){this.brush.setBorderColor(t)},PDFAnnotate.prototype.setBorderSize=function(t){this.brush.setBorderSize(t)},PDFAnnotate.prototype.clearActivePage=function(){var t=this.fabricObjects[this.active_canvas],e=t.backgroundImage;confirm("Are you sure?")&&(t.clear(),t.setBackgroundImage(e,t.renderAll.bind(t)))},PDFAnnotate.prototype.serializePdf=function(e){var n=this,o=[];n.fabricObjects.forEach(function(t){t.clone(function(t){t.setBackgroundImage(null),t.setBackgroundColor(""),o.push(t),o.length===n.fabricObjects.length&&(t={page_setup:{format:n.format,orientation:n.orientation},pages:o},e(JSON.stringify(t)))})})},PDFAnnotate.prototype.loadFromJSON=function(t){var n=this,{page_setup:e,pages:o}=t;void 0===o&&(o=t),"object"==typeof e&&"string"==typeof e.format&&"string"==typeof e.orientation&&(n.format=e.format,n.orientation=e.orientation),$.each(n.fabricObjects,function(t,e){o.length>t&&e.loadFromJSON(o[t],function(){n.fabricObjectsData[t]=e.toJSON()})})},PDFAnnotate.prototype.setDefaultTextForTextBox=function(t){"string"==typeof t&&(this.textBoxText=t)};
